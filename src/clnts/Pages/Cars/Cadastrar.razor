@page "/cadastrar"
@inject ParkedController parkingService
@inject ClassificationController classificationService

<div class="row">

    <div>
        <h1>Alocar Veículo</h1>

        <p>Selecione a imagem do veículo que deseja identificar.</p>

        <InputFile OnChange="HandleSelection" />


        <p>@status</p>
    </div>

    <div class="col-md-6">
        <div class="col-md-6">

            @if (!String.IsNullOrEmpty(imageData))
            {
                <img src="@imageData" height="250" />
            }
        </div>
    </div>

    <div class="col-md-10">
        <div class="col">
            @if (registred == null)
            {
                <button @onclick="AlocateNewCar" type="submit">Alocar carro</button>
            }
            else
            {
                <p>
                    <label>Fabricante: </label>
                    <label>@registred.Car.Model.Manufacturer.Name</label>
                </p>

                <p>
                    <label>Modelo: </label>
                    <label> @registred.Car.Model.Name </label>
                </p>

                <p>
                    <label>Ano: </label>
                    <label> @registred.Car.Model.Year </label>
                </p>

                <p>
                    <label>Tipo: </label>
                    <label> @registred.Car.Type.Name </label>
                </p>

                <p>
                    <label>Certeza: </label>
                    <label> @registred.Accuracy </label>
                </p>


                <button @onclick="AlocateNewCar" type="submit">Alocar carro</button>
            }

            @if (result == "")
            {

            }
            else
            {
                <p>@result</p>
            }
        </div>
    </div>



</div>

@code {
    string status;

    string imageData = String.Empty;

    string result = String.Empty;

    public ClassificationCar registred;


    async Task HandleSelection(IFileListEntry[] files)
    {
        var file = files.FirstOrDefault();

        var ms = new MemoryStream();

        if (file != null)
        {

            await file.Data.CopyToAsync(ms);

            status = $"Upload concluido, {file.Size} bytes.s";

            imageData = $"data:image/jpg;base64,{Convert.ToBase64String(ms.ToArray())}";
        }

        registred = await classificationService.GetCassification(Convert.ToBase64String(ms.ToArray()));
    }

    //Aloca um carro no estacionamento
    public async Task AlocateNewCar()
    {
        if (registred.Car.Model != null && registred.Car.Type != null)
        {
            var x = await parkingService.NewParkedAsync(registred.Car);

            if (x != null)
            {
                result = ("Veículo alocado na vaga: Nome: " + x.Name + " | Distância da porta: " + x.DistDoor);
            }
            else
            {
                result = "Erro ao realizar alocação do veículo.";
            }
        }
    }

}